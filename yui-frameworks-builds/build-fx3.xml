<?xml version="1.0" encoding="utf-8"?>
<project name="yui-frameworks" basedir="." default="all">
    <!-- -->
    <property file="flex3.properties" />
    <property file="build.properties" />
    <taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}${file.separator}ant${file.separator}lib${file.separator}flexTasks.jar"/>

    <!-- -->
    <target name="all">
        <antcall target="fx3-fp10" />
        <antcall target="fx3-fp9" />

        <antcall target="fx3-rpc-fp10" />
        <antcall target="fx3-rpc-fp9" />
        
        <antcall target="fx3-ds-fp10" />
        <antcall target="fx3-ds-fp9" />
        
        <antcall target="fx3-air-fp10" />
        <antcall target="fx3-air-fp9" />
        
        <antcall target="fx3-airrpc-fp10" />
        <antcall target="fx3-airrpc-fp9" />
        
        <antcall target="fx3-airds-fp10" />
        <antcall target="fx3-airds-fp9" />
    </target>

    <target name="fx3-fp10">
        <ant antfile="projects${file.separator}build-fx3-fp10.xml" />
    </target>
    <target name="fx3-fp9">
        <ant antfile="projects${file.separator}build-fx3-fp9.xml" />
    </target>
    <target name="fx3-rpc-fp10">
        <ant antfile="projects${file.separator}build-fx3-rpc-fp10.xml" />
    </target>
    <target name="fx3-rpc-fp9">
        <ant antfile="projects${file.separator}build-fx3-rpc-fp9.xml" />
    </target>
    <target name="fx3-ds-fp10">
        <ant antfile="projects${file.separator}build-fx3-ds-fp10.xml" />
    </target>
    <target name="fx3-ds-fp9">
        <ant antfile="projects${file.separator}build-fx3-ds-fp9.xml" />
    </target>
    <target name="fx3-air-fp10">
        <ant antfile="projects${file.separator}build-fx3-air-fp10.xml" />
    </target>
    <target name="fx3-air-fp9">
        <ant antfile="projects${file.separator}build-fx3-air-fp9.xml" />
    </target>
    <target name="fx3-airrpc-fp10">
        <ant antfile="projects${file.separator}build-fx3-airrpc-fp10.xml" />
    </target>
    <target name="fx3-airrpc-fp9">
        <ant antfile="projects${file.separator}build-fx3-airrpc-fp9.xml" />
    </target>
    <target name="fx3-airds-fp10">
        <ant antfile="projects${file.separator}build-fx3-airds-fp10.xml" />
    </target>
    <target name="fx3-airds-fp9">
        <ant antfile="projects${file.separator}build-fx3-airds-fp9.xml" />
    </target>

    <!--
    <target name="all">
        <antcall target="all-for-flashplayer10" />
        <antcall target="all-for-flashplayer9" />
    </target>

    <target name="all-for-flashplayer10">
        <property name="LIB_FLASHPLAYER" value="10" />
        <antcall target="clean" />
        <ant antfile="build-flex3.xml" />
        <ant antfile="build-flex3-ds.xml" />
        <ant antfile="build-flex3-air.xml" />
    </target>

    <target name="all-for-flashplayer9">
        <property name="LIB_FLASHPLAYER" value="9" />
        <antcall target="clean" />
        <ant antfile="build-flex3.xml" />
        <ant antfile="build-flex3-ds.xml" />
    </target>
    -->

    <macrodef name="projectInit">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <sequential>
            <echo message="@{projectname} Project initialize at @{projectdir}." />
            <delete dir="@{projectdir}" />
            <mkdir dir="@{projectdir}" />
        </sequential>
    </macrodef>

    <macrodef name="projectAddSubProject">
        <attribute name="projectdir" />
        <attribute name="subprojectdir" />
        <sequential>
            <echo message="Add Project @{projectdir}" />

            <!-- -->
            <echo message="Add Include File" />
            <property name="project-includes-config" value="@{projectdir}${FLEX_INCLUDE_CONFIG_PATH}" />

            <concat destfile="${project-includes-config}" fixlastline="true" append="true" encoding="utf-8">
                <filelist>
                    <file name="@{subprojectdir}${file.separator}${FLEX_LIB_PROPERTIES}" />
                </filelist>
            </concat>
            <echo message="@{subprojectdir}${file.separator}${FLEX_LIB_PROPERTIES} add to ${project-includes-config}." />

            <!-- -->
            <echo message="Add Manifest File" />
            <property name="project-manifest" value="@{projectdir}${FLEX_MANIFEST_PATH}" />

            <concat destfile="${project-manifest}" fixlastline="true" append="true" encoding="utf-8">
                <filelist>
                    <file name="@{subprojectdir}${FLEX_MANIFEST_PATH}" />
                </filelist>
            </concat>
            <echo message="@{subprojectdir}${FLEX_MANIFEST_PATH} add to ${project-manifest}." />

            <!-- -->
            <echo message="Add Defaults CSS File" />
            <property name="project-defaults_css" value="@{projectdir}${FLEX_DEFAULT_CSS_PATH}" />

            <concat destfile="${project-defaults_css}" fixlastline="true" append="true" encoding="utf-8">
                <filelist>
                    <file name="@{subprojectdir}${FLEX_DEFAULT_CSS_PATH}" />
                </filelist>
            </concat>
            <echo message="@{subprojectdir}${FLEX_DEFAULT_CSS_PATH} add to ${project-defaults_css}." />

            <!-- -->
            <echo message="Copy Sources" />
            <copy todir="@{projectdir}${FLEX_SRC}" overwrite="true">
                <fileset dir="@{subprojectdir}${FLEX_SRC}">
                    <exclude name="*Classes.as" />
                    <exclude name="*.xml" />
                    <exclude name="*.properties" />
                </fileset>
            </copy>
            <copy todir="@{projectdir}${FLEX_LOCALE}" overwrite="true">
                <fileset dir="@{subprojectdir}${FLEX_LOCALE}">
                </fileset>
            </copy>
        </sequential>
    </macrodef>

    <macrodef name="projectCompilePrepare">
        <attribute name="projectdir" />
        <sequential>

            <echo message="Compile on @{projectdir}${FLEX_SWC_OUTPUT}${FLEX_SRC}." />

            <property name="project-includes-config" value="@{projectdir}${file.separator}${FLEX_SWC_OUTPUT}${file.separator}${FLEX_INCLUDE_CONFIG_PATH}" />

            <replaceregexp file="${project-includes-config}" replace="&lt;includeClasses&gt;&lt;/includeClasses&gt;" flags="gs" byline="false">
                <regexp pattern="&lt;includeClasses\s*/&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="" flags="gs" byline="false">
                <regexp pattern="&lt;/includeClasses.*?includeClasses&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="" flags="gs" byline="false">
                <regexp pattern="&lt;includeResources.*?&lt;/namespaceManifests&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="" flags="gs" byline="false">
                <regexp pattern="&lt;includeResources.*/&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="" flags="gs" byline="false">
                <regexp pattern="&lt;namespaceManifests.*/&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="flex-config" flags="gs" byline="true">
                <regexp pattern="flexLibProperties" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="flex-config xmlns=&quot;http://www.adobe.com/2006/flex-config&quot;" flags="gs" byline="true">
                <regexp pattern="flex-config version=&quot;.+&quot;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="includes" flags="gs" byline="true">
                <regexp pattern="includeClasses" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="&lt;symbol&gt;" flags="gs" byline="true">
                <regexp pattern="&lt;classEntry path=&quot;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="&lt;/symbol&gt;" flags="gs" byline="false">
                <regexp pattern="&quot;/&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-includes-config}" replace="" flags="gs" byline="false">
                <regexp pattern="${line.separator}" />
            </replaceregexp>

            <echo message="Check Include File is ${project-includes-config}." />

            <property name="project-manifest" value="@{projectdir}${file.separator}${FLEX_SWC_OUTPUT}${file.separator}${FLEX_MANIFEST_PATH}" />

            <replaceregexp file="${project-manifest}" replace="" flags="gs" byline="false">
                <regexp pattern="&lt;/componentPackage&gt;.*?&lt;componentPackage&gt;" />
            </replaceregexp>

            <replaceregexp file="${project-manifest}" replace="" flags="gs" byline="false">
                <regexp pattern="${line.separator}" />
            </replaceregexp>

        </sequential>
    </macrodef>

    <macrodef name="projectCompileWithFlexLibrary9">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <attribute name="flashplayer" />
        <sequential>
            <property name="project-locale-ja-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}ja_JP${file.separator}"/>
            <property name="project-locale-en-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}en_US${file.separator}"/>
            <property name="project-full-name" value="@{projectname}-${LIB_VERSION}"/>

            <compc output="@{projectdir}${FLEX_OUTPUT}${file.separator}${project-full-name}${FLEX_SWC_SUFFIX}" compute-digest="true" incremental="false" debug="${LIB_DEBUG_MODE}" optimize="${LIB_OPTIMIZE}" target-player="@{flashplayer}" locale="">
                <define name="CONFIG::DEBUG" value="${LIB_DEBUG_MODE}" />
                <define name="CONFIG::DEBUG_EVENT" value="false" />
                <define name="CONFIG::FP9" value="true" />
                <define name="CONFIG::FP10" value="false" />
                <define name="CONFIG::UNCAUGHT_ERROR_EVENT" value="true" />
                <define name="CONFIG::UNCAUGHT_ERROR_GLOBAL" value="false" />
                <load-config filename="${FLEX_HOME}${file.separator}frameworks${file.separator}flex-config.xml" />
                <load-config filename="@{projectdir}${FLEX_INCLUDE_CONFIG_PATH}" />
                <source-path path-element="${projectdir}${FLEX_SRC}" />

                <include-namespaces uri="${LIB_NAMESPACE}" />

                <namespace uri="${LIB_NAMESPACE}" manifest="@{projectdir}${FLEX_MANIFEST_PATH}" />

                <include-file name="locale/ja_JP/yui_framework.properties" path="${project-locale-ja-dir}yui_framework.properties" />
                <include-file name="locale/ja_JP/yui_core.properties" path="${project-locale-ja-dir}yui_core.properties" />
                <include-file name="locale/ja_JP/log4yui.properties" path="${project-locale-ja-dir}log4yui.properties" />
                <include-file name="locale/ja_JP/application.properties" path="${project-locale-ja-dir}application.properties" />
                <include-file name="locale/ja_JP/messages.properties" path="${project-locale-ja-dir}messages.properties" />
                <include-file name="locale/ja_JP/errors.properties" path="${project-locale-ja-dir}errors.properties" />

                <include-file name="locale/en_US/yui_framework.properties" path="${project-locale-en-dir}yui_framework.properties" />
                <include-file name="locale/en_US/yui_core.properties" path="${project-locale-en-dir}yui_core.properties" />
                <include-file name="locale/en_US/log4yui.properties" path="${project-locale-en-dir}log4yui.properties" />
                <include-file name="locale/en_US/application.properties" path="${project-locale-en-dir}application.properties" />
                <include-file name="locale/en_US/messages.properties" path="${project-locale-en-dir}messages.properties" />
                <include-file name="locale/en_US/errors.properties" path="${project-locale-en-dir}errors.properties" />

                <include-file name="defaults.css" path="@{projectdir}${FLEX_DEFAULT_CSS_PATH}" />

                <external-library-path dir="${FLEX_FRAMEWORK}" append="true">
                    <include name="libs" />
                </external-library-path>
            </compc>
        </sequential>
    </macrodef>

    <macrodef name="projectCompileWithFlexLibrary10">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <attribute name="flashplayer" />
        <attribute name="uncaughtError" />
        <sequential>
            <property name="project-locale-ja-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}ja_JP${file.separator}"/>
            <property name="project-locale-en-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}en_US${file.separator}"/>
            <property name="project-full-name" value="@{projectname}-${LIB_VERSION}"/>

            <compc output="@{projectdir}${FLEX_OUTPUT}${file.separator}${project-full-name}${FLEX_SWC_SUFFIX}" compute-digest="true" incremental="false" debug="${LIB_DEBUG_MODE}" optimize="${LIB_OPTIMIZE}" target-player="@{flashplayer}" locale="">
                <define name="CONFIG::DEBUG" value="${LIB_DEBUG_MODE}" />
                <define name="CONFIG::DEBUG_EVENT" value="false" />
                <define name="CONFIG::FP9" value="false" />
                <define name="CONFIG::FP10" value="true" />
                <define name="CONFIG::UNCAUGHT_ERROR_EVENT" value="@{uncaughtError} == 0" />
                <define name="CONFIG::UNCAUGHT_ERROR_GLOBAL" value="@{uncaughtError} == 1" />
                <load-config filename="${FLEX_HOME}${file.separator}frameworks${file.separator}flex-config.xml" />
                <load-config filename="@{projectdir}${FLEX_INCLUDE_CONFIG_PATH}" />
                <source-path path-element="${projectdir}${FLEX_SRC}" />

                <include-namespaces uri="${LIB_NAMESPACE}" />

                <namespace uri="${LIB_NAMESPACE}" manifest="@{projectdir}${FLEX_MANIFEST_PATH}" />

                <include-file name="locale/ja_JP/yui_framework.properties" path="${project-locale-ja-dir}yui_framework.properties" />
                <include-file name="locale/ja_JP/yui_core.properties" path="${project-locale-ja-dir}yui_core.properties" />
                <include-file name="locale/ja_JP/log4yui.properties" path="${project-locale-ja-dir}log4yui.properties" />
                <include-file name="locale/ja_JP/application.properties" path="${project-locale-ja-dir}application.properties" />
                <include-file name="locale/ja_JP/messages.properties" path="${project-locale-ja-dir}messages.properties" />
                <include-file name="locale/ja_JP/errors.properties" path="${project-locale-ja-dir}errors.properties" />

                <include-file name="locale/en_US/yui_framework.properties" path="${project-locale-en-dir}yui_framework.properties" />
                <include-file name="locale/en_US/yui_core.properties" path="${project-locale-en-dir}yui_core.properties" />
                <include-file name="locale/en_US/log4yui.properties" path="${project-locale-en-dir}log4yui.properties" />
                <include-file name="locale/en_US/application.properties" path="${project-locale-en-dir}application.properties" />
                <include-file name="locale/en_US/messages.properties" path="${project-locale-en-dir}messages.properties" />
                <include-file name="locale/en_US/errors.properties" path="${project-locale-en-dir}errors.properties" />

                <include-file name="defaults.css" path="@{projectdir}${FLEX_DEFAULT_CSS_PATH}" />

                <external-library-path dir="${FLEX_FRAMEWORK}" append="true">
                    <include name="libs" />
                </external-library-path>
            </compc>
        </sequential>
    </macrodef>

    <macrodef name="projectCompileWithAIRFlexLibrary9">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <attribute name="flashplayer" />
        <sequential>
            <property name="project-locale-ja-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}ja_JP${file.separator}"/>
            <property name="project-locale-en-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}en_US${file.separator}"/>
            <property name="project-full-name" value="@{projectname}-${LIB_VERSION}"/>

            <compc output="@{projectdir}${FLEX_OUTPUT}${file.separator}${project-full-name}${FLEX_SWC_SUFFIX}" compute-digest="true" incremental="false" debug="${LIB_DEBUG_MODE}" optimize="${LIB_OPTIMIZE}" target-player="@{flashplayer}" locale="">
                <define name="CONFIG::DEBUG" value="${LIB_DEBUG_MODE}" />
                <define name="CONFIG::DEBUG_EVENT" value="false" />
                <define name="CONFIG::FP9" value="true" />
                <define name="CONFIG::FP10" value="false" />
                <define name="CONFIG::UNCAUGHT_ERROR_EVENT" value="true" />
                <define name="CONFIG::UNCAUGHT_ERROR_GLOBAL" value="false" />
                <load-config filename="${FLEX_HOME}${file.separator}frameworks${file.separator}air-config.xml" />
                <load-config filename="@{projectdir}${FLEX_INCLUDE_CONFIG_PATH}" />
                <source-path path-element="${projectdir}${FLEX_SRC}" />

                <include-namespaces uri="${LIB_NAMESPACE}" />

                <namespace uri="${LIB_NAMESPACE}" manifest="@{projectdir}${FLEX_MANIFEST_PATH}" />

                <include-file name="locale/ja_JP/yui_framework.properties" path="${project-locale-ja-dir}yui_framework.properties" />
                <include-file name="locale/ja_JP/log4yui.properties" path="${project-locale-ja-dir}log4yui.properties" />
                <include-file name="locale/ja_JP/application.properties" path="${project-locale-ja-dir}application.properties" />
                <include-file name="locale/ja_JP/messages.properties" path="${project-locale-ja-dir}messages.properties" />
                <include-file name="locale/ja_JP/errors.properties" path="${project-locale-ja-dir}errors.properties" />

                <include-file name="locale/en_US/yui_framework.properties" path="${project-locale-en-dir}yui_framework.properties" />
                <include-file name="locale/en_US/log4yui.properties" path="${project-locale-en-dir}log4yui.properties" />
                <include-file name="locale/en_US/application.properties" path="${project-locale-en-dir}application.properties" />
                <include-file name="locale/en_US/messages.properties" path="${project-locale-en-dir}messages.properties" />
                <include-file name="locale/en_US/errors.properties" path="${project-locale-en-dir}errors.properties" />

                <include-file name="defaults.css" path="@{projectdir}${FLEX_DEFAULT_CSS_PATH}" />

                <external-library-path dir="${FLEX_FRAMEWORK}" append="true">
                    <include name="libs" />
                    <include name="libs/air" />
                </external-library-path>
            </compc>
        </sequential>
    </macrodef>
    <macrodef name="projectCompileWithAIRFlexLibrary10">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <attribute name="flashplayer" />
        <attribute name="uncaughtError" />
        <sequential>
            <property name="project-locale-ja-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}ja_JP${file.separator}"/>
            <property name="project-locale-en-dir" value="${projectdir}${file.separator}${FLEX_LOCALE}${file.separator}en_US${file.separator}"/>
            <property name="project-full-name" value="@{projectname}-${LIB_VERSION}"/>

            <compc output="@{projectdir}${FLEX_OUTPUT}${file.separator}${project-full-name}${FLEX_SWC_SUFFIX}" compute-digest="true" incremental="false" debug="${LIB_DEBUG_MODE}" optimize="${LIB_OPTIMIZE}" target-player="@{flashplayer}" locale="">
                <define name="CONFIG::DEBUG" value="${LIB_DEBUG_MODE}" />
                <define name="CONFIG::DEBUG_EVENT" value="false" />
                <define name="CONFIG::FP9" value="false" />
                <define name="CONFIG::FP10" value="true" />
                <define name="CONFIG::UNCAUGHT_ERROR_EVENT" value="@{uncaughtError} == 0" />
                <define name="CONFIG::UNCAUGHT_ERROR_GLOBAL" value="@{uncaughtError} == 1" />
                <load-config filename="${FLEX_HOME}${file.separator}frameworks${file.separator}air-config.xml" />
                <load-config filename="@{projectdir}${FLEX_INCLUDE_CONFIG_PATH}" />
                <source-path path-element="${projectdir}${FLEX_SRC}" />

                <include-namespaces uri="${LIB_NAMESPACE}" />

                <namespace uri="${LIB_NAMESPACE}" manifest="@{projectdir}${FLEX_MANIFEST_PATH}" />

                <include-file name="locale/ja_JP/yui_framework.properties" path="${project-locale-ja-dir}yui_framework.properties" />
                <include-file name="locale/ja_JP/log4yui.properties" path="${project-locale-ja-dir}log4yui.properties" />
                <include-file name="locale/ja_JP/application.properties" path="${project-locale-ja-dir}application.properties" />
                <include-file name="locale/ja_JP/messages.properties" path="${project-locale-ja-dir}messages.properties" />
                <include-file name="locale/ja_JP/errors.properties" path="${project-locale-ja-dir}errors.properties" />

                <include-file name="locale/en_US/yui_framework.properties" path="${project-locale-en-dir}yui_framework.properties" />
                <include-file name="locale/en_US/log4yui.properties" path="${project-locale-en-dir}log4yui.properties" />
                <include-file name="locale/en_US/application.properties" path="${project-locale-en-dir}application.properties" />
                <include-file name="locale/en_US/messages.properties" path="${project-locale-en-dir}messages.properties" />
                <include-file name="locale/en_US/errors.properties" path="${project-locale-en-dir}errors.properties" />

                <include-file name="defaults.css" path="@{projectdir}${FLEX_DEFAULT_CSS_PATH}" />

                <external-library-path dir="${FLEX_FRAMEWORK}" append="true">
                    <include name="libs" />
                    <include name="libs/air" />
                </external-library-path>
            </compc>
        </sequential>
    </macrodef>

    <macrodef name="projectRsl">
        <attribute name="projectname" />
        <attribute name="projectdir" />
        <attribute name="flashplayer" />
        <sequential>
            <property name="project-full-name" value="@{projectname}-${LIB_VERSION}"/>
            <property name="project-output" value="@{projectdir}${FLEX_OUTPUT}${file.separator}${project-full-name}"/>
            <property name="project-output-swc" value="${project-output}${FLEX_SWC_SUFFIX}"/>
            <property name="project-output-swf" value="${project-output}${FLEX_SWF_SUFFIX}"/>
            <unzip
                src="${project-output-swc}"
                dest="${project-output}"
                />
            <java jar="${FLEX_HOME}${file.separator}lib${file.separator}optimizer.jar" fork="true" failonerror="true">
                  <jvmarg line="-ea -DAS3 -DAVMPLUS -Dflexlib='${FLEX_HOME}${file.separator}frameworks' -Xms32m -Xmx384m -Dsun.io.useCanonCaches=false" />
                  <arg line="'${project-output}${file.separator}library.swf' --output '${project-output-swf}' --keep-as3-metadata='Bindable,Managed,ChangeEvent,NonCommittingChangeEvent,Transient,RemoteClass' " />
            </java>
            <java jar="${FLEX_HOME}${file.separator}lib${file.separator}digest.jar" fork="true" failonerror="true">
                   <jvmarg line="-ea -DAS3 -DAVMPLUS -Xms32m -Xmx384m -Dsun.io.useCanonCaches=false"/>
                   <arg line="--digest.rsl-file '${project-output-swf}' --digest.swc-path '${project-output-swc}'"/>
            </java>
        </sequential>
    </macrodef>
</project>
